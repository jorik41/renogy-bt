================================================================================
ESPHOME HANDSHAKE FIX voor renogy-bt 
Updated for aioesphomeapi 42.x+ protocol
================================================================================

PROBLEEM:
---------
De ESPHome API server werkte niet meer met nieuwe versies van Home Assistant die
aioesphomeapi 42.x gebruiken. De handshake faalde met "EOF received" timeout errors.

Het probleem zat in het verschil tussen oude en nieuwe ESPHome protocol:
- OUDE protocol (aioesphomeapi <42): length = msg_type varint size + payload size
- NIEUWE protocol (aioesphomeapi 42.x+): length = payload size ALLEEN

Dit veroorzaakte dat:
1. Server las 1 byte te weinig van het HelloRequest payload
2. Buffer raakte uit sync
3. Volgende message parsing faalde
4. Connectie werd gesloten met "EOF received"

OPLOSSING (November 2024):
--------------------------
Update zowel encoding als decoding om alleen payload size te gebruiken.

FIX IN renogybt/esphome_api_server.py:
---------------------------------------

ENCODING FIX (_make_packet functie):
```python
# VOOR (oude protocol):
length = len(msg_type_bytes) + len(payload)

# NA (nieuwe protocol - aioesphomeapi 42.x+):
length = len(payload)  # Only payload size, not including msg_type
```

DECODING FIX (data_received functie):
```python
# VOOR (oude protocol):
pos_before_msg_type = self._pos
msg_type = self._read_varuint()
msg_type_len = self._pos - pos_before_msg_type
payload_len = length - msg_type_len

# NA (nieuwe protocol - aioesphomeapi 42.x+):
msg_type = self._read_varuint()
payload_len = length  # length already IS the payload size
```
    return
```

NA (met fix):
```python
length = self._read_varuint()
if length == -1:
    logger.error("Failed to read length; closing connection")
    self._reset_buffer()
    self._close_transport()
    return

# Remember position before reading msg_type to calculate its size
pos_before_msg_type = self._pos

msg_type = self._read_varuint()
if msg_type == -1:
    logger.error("Failed to read message type; closing connection")
    self._reset_buffer()
    self._close_transport()
    return

# Calculate how many bytes the msg_type varint consumed
msg_type_len = self._pos - pos_before_msg_type

if length == 0:
    self._remove_from_buffer()
    self._process_packet(msg_type, b"")
    continue

# length includes msg_type, so subtract it to get payload length
payload_len = length - msg_type_len
packet = self._read(payload_len)  # <-- CORRECT: leest alleen payload
if packet is None:
    return
```

TOEPASSEN OP PI ZERO:
----------------------
Op je Pi Zero 2W:

1. ssh naar je Pi
2. cd /pad/naar/renogy-bt
3. git pull origin copilot/fix-esp-home-assistant-timeout
4. Herstart je service: sudo systemctl restart renogy-bt-proxy

TESTEN:
-------
Na de fix kun je testen met:
```bash
python3 tools/test_esphome_api.py
```

Of gebruik de aioesphomeapi test:
```bash
python3 << 'EOF'
import asyncio
from aioesphomeapi import APIClient

async def test():
    client = APIClient("127.0.0.1", 6053, "")
    await client.connect()
    info = await client.device_info()
    print(f"✓ Connected to {info.name}")
    await client.disconnect()

asyncio.run(test())
EOF
```

Je zou nu moeten zien:
✓ TCP connection established
✓ Received HelloResponse
✓ Received AuthenticationResponse
✓ Connected successfully

ACHTERGROND:
------------
De protocol wijziging werd geïntroduceerd in aioesphomeapi versie 42.x.
Home Assistant 2024.11+ gebruikt deze nieuwe versie, daarom werkte het
"vanmorgen" nog maar na een Home Assistant update niet meer.

De fix is backwards compatible: oude clients werken nog steeds omdat
hun length veld (msg_type + payload) wordt correct geïnterpreteerd
als alleen payload wanneer msg_type altijd 1 byte is (wat het geval is
voor alle standaard message types < 128).

================================================================================
