diff --git a/renogybt/esphome_api_server.py b/renogybt/esphome_api_server.py
index 10d31ee..5d58925 100644
--- a/renogybt/esphome_api_server.py
+++ b/renogybt/esphome_api_server.py
@@ -133,6 +133,9 @@ class ESPHomeAPIProtocol(asyncio.Protocol):
                 self._close_transport()
                 return
 
+            # Remember position before reading msg_type to calculate its size
+            pos_before_msg_type = self._pos
+            
             msg_type = self._read_varuint()
             if msg_type == -1:
                 logger.error("Failed to read message type; closing connection")
@@ -140,12 +143,17 @@ class ESPHomeAPIProtocol(asyncio.Protocol):
                 self._close_transport()
                 return
 
+            # Calculate how many bytes the msg_type varint consumed
+            msg_type_len = self._pos - pos_before_msg_type
+
             if length == 0:
                 self._remove_from_buffer()
                 self._process_packet(msg_type, b"")
                 continue
 
-            packet = self._read(length)
+            # length includes msg_type, so subtract it to get payload length
+            payload_len = length - msg_type_len
+            packet = self._read(payload_len)
             if packet is None:
                 return  # Wait for the rest of the packet
 
